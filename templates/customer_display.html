{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caribbean Voice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overflow: hidden;
            background: #f4f6fa;
        }
        
        .product-enter {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .7;
            }
        }
        
        .slide-fade {
            animation: slideFade 8s ease-in-out infinite;
        }
        
        @keyframes slideFade {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        
        .thank-you-message span {
            display: inline-block;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.8s forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- Main Content - Carte centrale unique -->
    <div class="flex-1 flex items-center justify-center min-h-screen bg-[#f8fafc]">
        <div class="bg-white rounded-none shadow-2xl px-0 py-14 w-full flex flex-col items-center animate-fadein" style="min-height: 100vh; position:relative; overflow:hidden;">
            <!-- Ic√¥nes anim√©es autour du logo -->
            <div id="icon-container" class="relative flex items-center justify-center mb-8" style="height: 140px; width: 140px;"></div>
            <h1 id="main-title" class="text-5xl font-extrabold text-slate-900 text-center drop-shadow mb-2 animate-title">Bienvenue chez Caribbean Voice</h1>
            <p id="typing-slogan" class="text-2xl text-blue-700 text-center font-semibold mb-4 animate-fadein2" style="min-height:2.5em;"></p>
            <div id="clock" class="text-2xl font-semibold text-slate-700 mt-2 animate-fadein2"></div>
        </div>
        <style>
            .animate-bounce-slow { animation: bounce 2.5s infinite; }
            @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-18px); } }
        </style>
        <script>
        // D√©tection de la f√™te et adaptation du style
        function getCurrentEvent() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            // No√´l : 15 d√©cembre - 31 d√©cembre
            if (month === 12 && day >= 15) return 'noel';
            // Nouvel An : 1 janvier - 7 janvier
            if (month === 1 && day <= 7) return 'nouvelan';
            // P√¢ques (approximatif, avril)
            if (month === 4) return 'paques';
            // √ât√© : juillet-ao√ªt
            if (month === 7 || month === 8) return 'ete';
            return 'normal';
        }

        const eventConfig = {
            noel: {
                icons: [
                    '<svg class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-10 text-green-600 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2l2.09 6.26L20 9.27l-5 4.87L16.18 21 12 17.77 7.82 21 9 14.14l-5-4.87 5.91-.91L12 2z"/></svg>',
                    '<svg class="absolute right-0 top-1/2 -translate-y-1/2 w-10 h-10 text-red-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h8m-4-4v8"/></svg>',
                    '<svg class="absolute left-1/2 -translate-x-1/2 -top-4 w-10 h-10 text-yellow-400 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 11-16 0 8 8 0 0116 0z"/></svg>'
                ],
                slogans: [
                    "Joyeux No√´l chez Caribbean Voice !",
                    "Profitez des f√™tes avec nos offres sp√©ciales",
                    "Des cadeaux pour toute la famille"
                ],
                title: "Joyeux No√´l chez Caribbean Voice"
            },
            nouvelan: {
                icons: [
                    '<svg class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-10 text-yellow-400 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
                    '<svg class="absolute right-0 top-1/2 -translate-y-1/2 w-10 h-10 text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h8m-4-4v8"/></svg>',
                    '<svg class="absolute left-1/2 -translate-x-1/2 -top-4 w-10 h-10 text-green-400 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v20m10-10H2"/></svg>'
                ],
                slogans: [
                    "Bonne Ann√©e chez Caribbean Voice !",
                    "Commencez l'ann√©e avec nos nouveaut√©s",
                    "Sant√©, bonheur et succ√®s √† tous !"
                ],
                title: "Bonne Ann√©e chez Caribbean Voice"
            },
            paques: {
                icons: [
                    '<svg class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-10 text-pink-400 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="8" ry="10" stroke-width="2"/></svg>',
                    '<svg class="absolute right-0 top-1/2 -translate-y-1/2 w-10 h-10 text-yellow-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/></svg>'
                ],
                slogans: [
                    "Joyeuses P√¢ques chez Caribbean Voice !",
                    "Des surprises pour petits et grands",
                    "Profitez du printemps avec nos offres"
                ],
                title: "Joyeuses P√¢ques chez Caribbean Voice"
            },
            ete: {
                icons: [
                    '<svg class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-10 text-yellow-400 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/></svg>',
                    '<svg class="absolute right-0 top-1/2 -translate-y-1/2 w-10 h-10 text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20"/></svg>'
                ],
                slogans: [
                    "Bel √©t√© chez Caribbean Voice !",
                    "Rafra√Æchissez-vous avec nos produits",
                    "Vacances, soleil et bonnes affaires"
                ],
                title: "Bel √©t√© chez Caribbean Voice"
            },
            normal: {
                icons: [
                    '<svg class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-10 text-yellow-400 animate-bounce-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
                    '<svg class="absolute right-0 top-1/2 -translate-y-1/2 w-10 h-10 text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h8m-4-4v8"/></svg>',
                    '<svg class="absolute left-1/2 -translate-x-1/2 -top-4 w-10 h-10 text-green-400 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v20m10-10H2"/></svg>'
                ],
                slogans: [
                    "Votre magasin de confiance pour l'√©lectronique et le solaire",
                    "Des solutions innovantes pour tous vos besoins",
                    "Service rapide, produits de qualit√©, prix imbattables"
                ],
                title: "Bienvenue chez Caribbean Voice"
            }
        };

        let sloganIndex = 0;
        let charIndex = 0;
        let typingForward = true;
        let currentSlogans = eventConfig.normal.slogans;
        function typeSlogan() {
            const el = document.getElementById('typing-slogan');
            if (!el) return;
            const slogan = currentSlogans[sloganIndex];
            if (typingForward) {
                charIndex++;
                if (charIndex > slogan.length) {
                    typingForward = false;
                    setTimeout(typeSlogan, 1200);
                    return;
                }
            } else {
                charIndex--;
                if (charIndex < 0) {
                    typingForward = true;
                    sloganIndex = (sloganIndex + 1) % currentSlogans.length;
                    setTimeout(typeSlogan, 600);
                    return;
                }
            }
            el.innerHTML = slogan.substring(0, charIndex) + '<span class="typing-cursor">|</span>';
            setTimeout(typeSlogan, typingForward ? 60 : 30);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // D√©tecte la f√™te et adapte le style
            const event = getCurrentEvent();
            const config = eventConfig[event];
            // Ic√¥nes
            document.getElementById('icon-container').innerHTML = '<img src="{% static 'images/caribbean_voice.jpg' %}" alt="Caribbean Voice" class="h-32 w-32 drop-shadow-xl rounded-full object-cover border-4 border-blue-100 z-10">' + config.icons.join('');
            // Slogan
            currentSlogans = config.slogans;
            sloganIndex = 0;
            charIndex = 0;
            typingForward = true;
            // Titre principal
            document.getElementById('main-title').textContent = config.title;
            // Lance l'animation typing
            typeSlogan();
        });
        </script>
        <style>
            .typing-cursor { color: #2563eb; animation: blink 1s steps(1) infinite; }
            @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }
        </style>
    </div>
    <style>
        .animate-fadein {
            animation: fadein 1.2s cubic-bezier(0.4,0,0.2,1);
        }
        .animate-fadein2 {
            animation: fadein2 2s cubic-bezier(0.4,0,0.2,1);
        }
        .animate-title {
            animation: popin 1.1s cubic-bezier(0.4,0,0.2,1);
        }
        @keyframes fadein {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadein2 {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popin {
            0% { opacity: 0; transform: scale(0.95) translateY(30px); }
            60% { opacity: 1; transform: scale(1.05) translateY(-8px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
    <style>
        .animate-fadein {
            animation: fadein 1.2s cubic-bezier(0.4,0,0.2,1);
        }
        @keyframes fadein {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

        <!-- Active State (Liste Produits) -->
        <div id="active-state" class="hidden flex-1 flex flex-col">
            <!-- Products List -->
            <div class="flex-1 bg-white rounded-2xl shadow-2xl p-8 overflow-hidden">
                <div class="h-full flex flex-col">
                    <h2 class="text-4xl font-bold text-slate-900 mb-6">Vos Achats</h2>
                    
                    <div class="flex-1 overflow-y-auto">
                        <table class="w-full">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="px-6 py-4 text-left text-2xl font-semibold text-slate-700">Produit</th>
                                    <th class="px-6 py-4 text-center text-2xl font-semibold text-slate-700">Qt√©</th>
                                    <th class="px-6 py-4 text-right text-2xl font-semibold text-slate-700">Prix Unit.</th>
                                    <th class="px-6 py-4 text-right text-2xl font-semibold text-slate-700">Total</th>
                                </tr>
                            </thead>
                            <tbody id="products-list" class="divide-y divide-slate-200">
                                <!-- Products will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totals -->
            <div class="mt-6 bg-white rounded-2xl shadow-2xl p-8">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-3xl font-semibold text-slate-700">Sous-total</span>
                        <span id="subtotal" class="text-3xl font-bold text-slate-900">0 HTG</span>
                    </div>
                    
                    <div id="discount-row" class="hidden flex justify-between items-center">
                        <span class="text-3xl font-semibold text-red-600">Remise</span>
                        <span id="discount" class="text-3xl font-bold text-red-600">0 HTG</span>
                    </div>
                    
                    <div id="tax-row" class="hidden flex justify-between items-center">
                        <span class="text-3xl font-semibold text-slate-700">Taxes</span>
                        <span id="tax" class="text-3xl font-bold text-slate-900">0 HTG</span>
                    </div>
                    
                    <div class="border-t-4 border-slate-300 pt-4">
                        <div class="flex justify-between items-center">
                            <span class="text-5xl font-bold text-slate-900">TOTAL</span>
                            <span id="total" class="text-6xl font-bold text-green-600">0 HTG</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment State -->
        <div id="payment-state" class="hidden flex-1 flex items-center justify-center text-white">
            <div class="text-center space-y-8">
                <div class="relative">
                    <svg class="w-48 h-48 mx-auto animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </div>
                <h2 class="text-6xl font-bold">Paiement en cours...</h2>
                <p class="text-3xl">Veuillez patienter</p>
            </div>
        </div>

        <!-- Thank You State -->
        <div id="thankyou-state" class="hidden flex-1 flex items-center justify-center text-white">
            <div class="text-center space-y-8">
                <svg class="w-48 h-48 mx-auto text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-7xl font-bold">Merci de votre visite !</h2>
                <div id="thankyou-message" class="text-4xl font-bold"></div>
                <div class="space-y-4">
                    <p class="text-4xl">Montant pay√© : <span id="amount-paid" class="font-bold">0 HTG</span></p>
                    <p class="text-4xl">Monnaie rendue : <span id="change-amount" class="font-bold text-green-400">0 HTG</span></p>
                </div>
                <p class="text-3xl mt-8">√Ä bient√¥t chez Caribbean Voice ! üéâ</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DISPLAY_ID = 'customer_display_' + Date.now();
        let currentState = 'idle'; // idle, active, payment, thankyou
        let cart = [];
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        
        // Clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('clock').textContent = timeString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // State Management
        function setState(newState) {
            // Hide all states
            document.getElementById('idle-state').classList.add('hidden');
            document.getElementById('active-state').classList.add('hidden');
            document.getElementById('payment-state').classList.add('hidden');
            document.getElementById('thankyou-state').classList.add('hidden');
            
            // Show new state
            document.getElementById(newState + '-state').classList.remove('hidden');
            currentState = newState;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-HT', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount) + ' HTG';
        }

        // Update display
        function updateDisplay() {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';
            
            let subtotal = 0;
            
            cart.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'product-enter';
                row.innerHTML = `
                    <td class="px-6 py-4 text-2xl text-slate-900">${item.name}</td>
                    <td class="px-6 py-4 text-2xl text-center font-semibold text-blue-600">${item.quantity}</td>
                    <td class="px-6 py-4 text-2xl text-right text-slate-700">${formatCurrency(item.price)}</td>
                    <td class="px-6 py-4 text-2xl text-right font-bold text-slate-900">${formatCurrency(item.price * item.quantity)}</td>
                `;
                productsList.appendChild(row);
                
                subtotal += item.price * item.quantity;
            });
            
            // Update totals
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            
            // Discount (if any)
            const discountPercent = cart.length > 0 && cart[0].discount ? cart[0].discount : 0;
            const discountAmount = subtotal * (discountPercent / 100);
            if (discountAmount > 0) {
                document.getElementById('discount-row').classList.remove('hidden');
                document.getElementById('discount').textContent = '-' + formatCurrency(discountAmount);
            } else {
                document.getElementById('discount-row').classList.add('hidden');
            }
            
            // Tax (if any)
            const taxPercent = 0; // No tax for now
            const taxAmount = (subtotal - discountAmount) * (taxPercent / 100);
            if (taxAmount > 0) {
                document.getElementById('tax-row').classList.remove('hidden');
                document.getElementById('tax').textContent = formatCurrency(taxAmount);
            } else {
                document.getElementById('tax-row').classList.add('hidden');
            }
            
            // Total
            const total = subtotal - discountAmount + taxAmount;
            document.getElementById('total').textContent = formatCurrency(total);
        }

        // WebSocket Connection (with fallback to polling)
        let ws = null;
        let pollingInterval = null;
        
        function connectWebSocket() {
            // Try WebSocket first
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/customer-display/`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    
                    // Register this display
                    ws.send(JSON.stringify({
                        type: 'register',
                        display_id: DISPLAY_ID
                    }));
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    fallbackToPolling();
                };
                
                ws.onclose = function() {
                    console.log('WebSocket closed');
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        setTimeout(connectWebSocket, 3000 * reconnectAttempts);
                    } else {
                        fallbackToPolling();
                    }
                };
            } catch (error) {
                console.error('WebSocket not supported:', error);
                fallbackToPolling();
            }
        }
        
        function fallbackToPolling() {
            console.log('Falling back to polling');
            if (pollingInterval) return;
            
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/pos/customer-display/poll/?display_id=${DISPLAY_ID}`);
                    const data = await response.json();
                    if (data.messages) {
                        data.messages.forEach(handleMessage);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 1000); // Poll every second
        }
        
        function handleMessage(data) {
            console.log('Received message:', data);
            
            switch (data.event) {
                case 'product_added':
                    addProduct(data.product);
                    break;
                    
                case 'product_removed':
                    removeProduct(data.product_id);
                    break;
                    
                case 'quantity_changed':
                    updateQuantity(data.product_id, data.quantity);
                    break;
                    
                case 'discount_applied':
                    applyDiscount(data.discount);
                    break;
                    
                case 'payment_started':
                    setState('payment');
                    break;
                    
                case 'payment_completed':
                    showThankYou(data.amount_paid, data.change);
                    break;
                    
                case 'sale_cancelled':
                    resetDisplay();
                    break;
                    
                case 'cart_updated':
                    cart = data.cart || [];
                    if (cart.length > 0) {
                        setState('active');
                        updateDisplay();
                    } else {
                        setState('idle');
                    }
                    break;
            }
        }
        
        function addProduct(product) {
            const existing = cart.find(item => item.id === product.id);
            if (existing) {
                existing.quantity += product.quantity || 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: product.quantity || 1
                });
            }
            
            setState('active');
            updateDisplay();
        }
        
        function removeProduct(productId) {
            cart = cart.filter(item => item.id !== productId);
            if (cart.length === 0) {
                setState('idle');
            } else {
                updateDisplay();
            }
        }
        
        function updateQuantity(productId, quantity) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = quantity;
                if (quantity <= 0) {
                    removeProduct(productId);
                } else {
                    updateDisplay();
                }
            }
        }
        
        function applyDiscount(discount) {
            cart.forEach(item => {
                item.discount = discount;
            });
            updateDisplay();
        }
        
        function showThankYou(amountPaid, change) {
            document.getElementById('amount-paid').textContent = formatCurrency(amountPaid);
            document.getElementById('change-amount').textContent = formatCurrency(change);
            setState('thankyou');
            animateThankYouMessage('Merci, √† la prochaine !');
            // Reset after 5 secondes
            setTimeout(resetDisplay, 5000);
        }
        function animateThankYouMessage(message) {
            const container = document.getElementById('thankyou-message');
            container.innerHTML = '';
            for (let i = 0; i < message.length; i++) {
                const span = document.createElement('span');
                span.textContent = message[i];
                span.style.animationDelay = (i * 0.08) + 's';
                container.appendChild(span);
            }
        }
        
        function resetDisplay() {
            cart = [];
            setState('idle');
        }
        
        // Request fullscreen
        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Request fullscreen
            setTimeout(requestFullscreen, 1000);
            
            // Connect WebSocket
            connectWebSocket();
            
            // Start in idle state
            setState('idle');
        });
        
        // Handle fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                // Exited fullscreen, request again
                setTimeout(requestFullscreen, 2000);
            }
        });
    </script>
</body>
</html>
